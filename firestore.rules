
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================

    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }
    
    function isPrivilegedUser() {
      if (request.auth == null) {
        return false;
      }
      // Check if the user is the hardcoded admin by email. This is the ultimate override.
      if (request.auth.token.email != null && request.auth.token.email.toLowerCase() == 'mustansir133@gmail.com') {
        return true;
      }
      // Fallback to check if the user has a privileged role in their profile document.
      if (exists(/databases/$(database)/documents/users/$(request.auth.uid))) {
        let userRole = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
        return userRole in ['Admin', 'it-support'];
      }
      return false;
    }

    // =================================
    // Path Rules
    // =================================

    match /users/{userId} {
      allow get: if isOwner(userId) || isPrivilegedUser();
      allow list: if isPrivilegedUser();
      // Only privileged users can create users through the UI.
      // An owner can update their own displayName/phoneNumber, but not their role/region.
      // Privileged users can update anything.
      allow create, update: if isPrivilegedUser();
      // Deleting users is a sensitive operation, only allow privileged users.
      // NOTE: This does not delete the Firebase Auth user.
      allow delete: if isPrivilegedUser();
    }

    // This rule allows admins and support to query across all users' tickets.
    match /{path=**}/issues/{issueId} {
      allow list: if isPrivilegedUser();
    }

    match /users/{userId}/issues/{issueId} {
      allow create: if isOwner(userId);
      allow get, update: if isOwner(userId) || isPrivilegedUser();
      allow delete: if isPrivilegedUser();
    }
    
    match /users/{userId}/issues/{issueId}/messages/{messageId} {
      allow read, create: if isOwner(userId) || isPrivilegedUser();
    }

    match /users/{userId}/notifications/{notificationId} {
      allow read, delete: if isOwner(userId);
      // Users can only mark notifications as read.
      allow update: if isOwner(userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
      // Privileged users (admins) can create notifications (fanned out from announcements).
      allow create: if isPrivilegedUser();
    }
    
    match /announcements/{announcementId} {
      allow read, write: if isPrivilegedUser();
    }
    
    match /system_settings/ticketCounter {
      // Any authenticated user can write to the ticket counter in a transaction to create a ticket.
      allow read, write: if request.auth != null;
    }
    
    match /system_settings/{settingId} {
        // All authenticated users can read settings like regions.
        allow read: if request.auth != null;
        // Only privileged users can change system settings like adding new regions.
        allow write: if isPrivilegedUser();
    }
  }
}
