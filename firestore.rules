
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =================================
    // Helper Functions
    // =================================

    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    function isRootUser() {
      return request.auth != null && request.auth.token.email != null && request.auth.token.email.toLowerCase() == 'mustansir133@gmail.com';
    }
    
    function isPrivilegedUser() {
      // A non-root user must be authenticated to be privileged.
      if (request.auth == null) {
        return false;
      }
      // If user is root user, they are privileged.
      if (isRootUser()) {
        return true;
      }
      if (exists(/databases/$(database)/documents/users/$(request.auth.uid))) {
        let userRole = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
        return userRole in ['Admin', 'it-support'];
      }
      return false;
    }

    // =================================
    // Root User Override
    // =================================
    // The root user has blanket read/write access to everything. This rule will grant
    // access if the user is the root user, regardless of other rules.
    match /{path=**} {
      allow read, write: if isRootUser();
    }

    // =================================
    // Path Rules for Non-Root Users
    // =================================

    match /users/{userId} {
      // Allow privileged users to list/read user profiles.
      // Allow users to read their own profile.
      allow get: if isOwner(userId) || isPrivilegedUser();
      allow list: if isPrivilegedUser();
      
      // Allow privileged users to create profiles.
      // Allow users to update their own profile.
      allow create: if isPrivilegedUser();
      allow update: if isOwner(userId) || isPrivilegedUser();
    }

    // Collection group query for privileged users to see all tickets.
    match /{path=**}/issues/{issueId} {
      allow list: if isPrivilegedUser();
    }

    match /users/{userId}/issues/{issueId} {
      allow create: if isOwner(userId);
      allow get, update: if isOwner(userId) || isPrivilegedUser();
      allow delete: if isPrivilegedUser();
    }
    
    match /users/{userId}/issues/{issueId}/messages/{messageId} {
      allow read, create: if isOwner(userId) || isPrivilegedUser();
    }

    match /users/{userId}/notifications/{notificationId} {
      allow read, delete: if isOwner(userId);
      allow update: if isOwner(userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);
      allow create: if isPrivilegedUser();
    }
    
    match /announcements/{announcementId} {
      allow read, write: if isPrivilegedUser();
    }
    
    match /system_settings/ticketCounter {
      // Any authenticated user can write to the ticket counter in a transaction.
      allow read, write: if request.auth != null;
    }
    
    match /system_settings/{settingId} {
        allow read: if request.auth != null; // All auth'd users can read settings like regions.
        allow write: if isPrivilegedUser();
    }
  }
}
